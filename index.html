<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="HEMS Logger">
  <meta name="theme-color" content="#0b0c10">
  <title>HEMS Fuel/Flight Logger — Preview</title>
  <style>
    :root { --bg:#0b0c10; --card:#15171c; --text:#e8eaed; --muted:#9aa0a6; --muted2:#c0c4ca; --accent:#40c057; --safe-bottom: env(safe-area-inset-bottom); --safe-top: env(safe-area-inset-top); }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Apple Color Emoji,Noto Color Emoji;color:var(--text);background:#0b0c10;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-text-size-adjust:100%;padding-top:calc(var(--safe-top,0) + 0px);}  
    .wrap{max-width:820px;margin:0 auto;padding:16px 16px 160px;}
    .title{font-size:22px;font-weight:700;margin:8px 0 2px}
    .sub{font-size:12px;color:var(--muted);margin-bottom:14px}
    .card{background:var(--card);border:1px solid #23262d;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:480px){ .row{grid-template-columns:1fr; gap:12px} }
    label{font-size:12px;color:var(--muted);display:block;margin:8px 0 6px}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a2e36;background:#0e1014;color:var(--text);font-size:17px;-webkit-appearance:none;appearance:none}
    input[type="datetime-local"],input[type="date"]{color-scheme:dark}
    .btns{position:fixed;left:0;right:0;bottom:0;background:rgba(11,12,16,.92);backdrop-filter:blur(10px);display:flex;gap:12px;padding:14px; padding-bottom:calc(14px + var(--safe-bottom,0)); border-top:1px solid #23262d;flex-wrap:wrap;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
    .btn{flex:1;padding:14px 16px;border-radius:14px;border:1px solid #2a2e36;background:#101319;color:var(--text);font-weight:700;cursor:pointer;touch-action:manipulation;-webkit-tap-highlight-color:transparent}
    .btn.primary{background:var(--accent);border-color:transparent;color:#07120a}
    .btn.ghost{background:transparent}
    .mini{font-size:12px;color:var(--muted)}
    pre.list{white-space:pre; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:13px; line-height:1.2; padding:10px; color:var(--muted2); text-align:left}
    #tests{display:none; font-family: ui-monospace, monospace; font-size:12px; color:#c0ffc0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">HEMS Fuel/Flight Logger</div>
    <div class="sub">Order: +Added Fuel (L) → Start Fuel (kg) → Location → Take-off → Landing → End Fuel (kg)</div>

    <div class="card">
      <div class="row">
        <div>
          <label>Flight time (minutes)</label>
          <input id="flightMins" type="number" step="1" inputmode="numeric" placeholder="e.g. 42"/>
        </div>
        <div>
          <label style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <span>Landing time (auto now, editable)</span>
            <button id="nowBtn" type="button" class="btn" style="flex:0 0 auto;padding:8px 10px;font-size:12px">Update Now</button>
          </label>
          <input id="tLand" type="datetime-local"/>
          <div class="mini" id="timeStatus"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Take-off time (calculated)</label>
          <input id="tOff" type="datetime-local" readonly/>
        </div>
        <div>
          <label>Location</label>
          <div style="display:flex; gap:8px; flex-wrap:nowrap; align-items:center">
            <input id="loc" type="text" placeholder="SP123456 or EGBE" style="flex:1; min-width:0"/>
            <button class="btn" id="gpsBtn" style="flex:0 0 auto; padding:10px 12px; white-space:nowrap">GPS</button>
          </div>
          <div class="mini" id="gpsStatus"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Fuel added (L)</label>
          <input id="fuelAdded" type="number" step="0.1" inputmode="decimal"/>
        </div>
        <div>
          <label>Fuel start (kg)</label>
          <input id="fuelStart" type="number" step="0.1" inputmode="decimal"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Landing fuel (kg)</label>
          <input id="fuelEnd" type="number" step="0.1" inputmode="decimal"/>
        </div>
        <div>
          <label>Date</label>
          <input id="date" type="date"/>
        </div>
      </div>

      <div id="summary" style="margin-top:10px;font-size:13px;color:var(--muted)"></div>
    </div>

    <div style="height:12px"></div>

    <div class="card">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap">
        <div class="mini">Saved records</div>
        <div style="display:flex; gap:8px;flex-wrap:wrap">
          <button class="btn ghost" id="todayBtn">Today</button>
          <button class="btn ghost" id="allBtn">All</button>
          <button class="btn" id="exportBtn">Export CSV</button>
          <button class="btn" id="clearTodayBtn" title="Delete all of today's records">Clear Today</button>
        </div>
      </div>
      <pre class="list" id="list"></pre>
      <pre id="tests"></pre>
    </div>
  </div>

  <div class="btns">
    <button class="btn" id="installBtn" title="Install the app">Install</button>
    <button class="btn primary" id="saveBtn">Save record</button>
  </div>
  <div id="iosHint" style="position:fixed;left:0;right:0;bottom:calc(60px + var(--safe-bottom,0));display:none;justify-content:center;pointer-events:none">
    <div style="background:#111318d9;border:1px solid #2a2e36;color:#e8eaed;padding:8px 10px;border-radius:10px;font-size:12px">On iPhone: Share → Add to Home Screen</div>
  </div>

  <script>
    // ===== Utilities & constants =====
    const $ = (id)=>document.getElementById(id);
    const LS_KEY = 'hems_min_logger_v6_preview';
    const DENSITY = 0.8; // L → kg
    let baseStartKg = 0;
    let currentFilter='today';

    const pad = (n)=>String(n).padStart(2,'0');
    const toDT = (d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    const todayStr = ()=>{const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;};
    const numFrom = (id)=>{ const el=$(id); const v=(el?.value||'').toString().trim().replace(',', '.'); const n=parseFloat(v); return Number.isFinite(n)?n:0; };

    // ----- capture programmatic assignments to tLand, even if invalid for datetime-local
    function patchLandingValueCapture(){
      const el = $('tLand');
      if(!el || el._valuePatched) return;
      const proto = Object.getPrototypeOf(el);
      const desc = Object.getOwnPropertyDescriptor(proto, 'value');
      if(desc && desc.set && desc.get){
        Object.defineProperty(el, 'value', {
          configurable: true,
          get(){ return desc.get.call(this); },
          set(v){ this._rawAssignedValue = v; return desc.set.call(this, v); }
        });
        el._valuePatched = true;
      }
    }
    function getLandingRaw(){
      const el = $('tLand');
      if(!el) return '';
      return el.value || el._rawAssignedValue || '';
    }

    // Normalize a date string to YYYY-MM-DD or return '' if invalid
    function asYYYYMMDD(input){
      if(!input) return '';
      if(/^\d{4}-\d{2}-\d{2}$/.test(input)) return input; // already date-only
      const t = Date.parse(input);
      if(Number.isNaN(t)) return '';
      const d = new Date(t);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // Robustly set a <input type="date"> value across odd engines (incl. iOS/WebView)
    function setDateValue(el, ymd){
      if(!el || !ymd) return false;
      el.value = ymd;
      el.setAttribute('value', ymd);
      try{ el.valueAsDate = new Date(ymd + 'T00:00:00'); }catch(e){}
      if(el.value !== ymd){
        const prevType = el.getAttribute('type') || el.type || 'date';
        try{ el.setAttribute('type','text'); el.value = ymd; el.setAttribute('type', prevType); }catch(e){}
      }
      return el.value === ymd;
    }

    // --- Keep bottom Date in lockstep with Landing time ---
    function syncDateToLanding(){
      const landValRaw = getLandingRaw();
      const raw = landValRaw && landValRaw.includes('T') ? landValRaw.split('T')[0] : landValRaw;
      const ymd = asYYYYMMDD(raw);
      if(!ymd) return;
      const dateEl = $('date');
      setDateValue(dateEl, ymd);
    }

    // ===== Init today fields =====
    function setTodayFields(){
      const now = new Date();
      $('tLand').value = toDT(now);
      syncDateToLanding();
      const s = $('timeStatus'); if(s) s.textContent = 'Landing pre-filled to now';
    }

    // ===== Time math =====
    const minutesToHHMM = (mins)=>{ mins=Math.max(0,Math.floor(mins||0)); const h=Math.floor(mins/60), m=mins%60; return `${pad(h)}:${pad(m)}`; };
    function diffHHMM(tOff,tLand){ if(!tOff||!tLand) return ''; const a=new Date(tOff).getTime(), b=new Date(tLand).getTime(); if(!isFinite(a)||!isFinite(b)) return ''; return minutesToHHMM(Math.max(0,Math.round((b-a)/60000))); }

    // ===== Recalc take-off when flight minutes or landing changes =====
    function attachInstantCalc(){
      const recalc = ()=>{
        const mins = parseInt(numFrom('flightMins'),10);
        const landVal = getLandingRaw();
        if(mins>0 && landVal){
          const takeoff = new Date(new Date(landVal).getTime() - mins*60000);
          $('tOff').value = toDT(takeoff);
        } else {
          $('tOff').value='';
        }
        if(landVal) syncDateToLanding();
      };
      ['flightMins','tLand'].forEach(id=>$(id).addEventListener('input', recalc));
      ['tLand'].forEach(id=>$(id).addEventListener('change', recalc));
      recalc();
    }

    // ===== Update Now button =====
    function setLandingNow(){
      const now=new Date();
      $('tLand').value=toDT(now);
      syncDateToLanding();
      $('flightMins').dispatchEvent(new Event('input'));
      const s=$('timeStatus'); if(s) s.textContent='Landing set to current time';
    }

    // ===== Fuel logic =====
    function populateFuelStart(){
      const all = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      if(all.length>0){ const last=all[all.length-1]; if(last.fuelEnd){ baseStartKg=parseFloat(last.fuelEnd)||0; $('fuelStart').value=baseStartKg; return; } }
      baseStartKg = numFrom('fuelStart'); $('fuelStart').value = baseStartKg ? baseStartKg.toFixed(1) : '';
    }
    function attachFuelLogic(){
      const sync=()=>{ const L=numFrom('fuelAdded'); const kg=L*DENSITY; $('fuelStart').value=(baseStartKg+kg).toFixed(1); };
      $('fuelAdded').addEventListener('input', sync);
      $('fuelAdded').addEventListener('change', sync);
      $('fuelStart').addEventListener('input', ()=>{ const L=numFrom('fuelAdded'); const kg=L*DENSITY; const v=numFrom('fuelStart'); if(Number.isFinite(v)) baseStartKg=v-kg; });
    }

    // ===== Save / list / export =====
    function save(){
      const tOff=$('tOff').value, tLand=getLandingRaw(); let flightHM=diffHHMM(tOff,tLand); if(!flightHM){ const mins=parseInt(numFrom('flightMins'),10); if(mins>0) flightHM=minutesToHHMM(mins); }
      const rec={ id:crypto.randomUUID(), date:$('date').value, fuelAdded:$('fuelAdded').value, fuelStart:$('fuelStart').value, loc:$('loc').value.trim().toUpperCase(), tOff, tLand, flightHM, fuelEnd:$('fuelEnd').value };
      const all=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); all.push(rec); localStorage.setItem(LS_KEY, JSON.stringify(all));
      baseStartKg = parseFloat(rec.fuelEnd)||0; $('summary').textContent='Saved.'; setTimeout(()=>{$('summary').textContent='';},1200); renderList('today'); clearForNext();
    }
    function clearForNext(){ setTodayFields(); $('tOff').value=''; $('fuelAdded').value=''; $('fuelEnd').value=''; $('loc').value=''; $('flightMins').value=''; $('fuelStart').value=Number.isFinite(baseStartKg)?baseStartKg.toFixed(1):''; $('fuelAdded').dispatchEvent(new Event('input')); }
    function loadAll(){ try{return JSON.parse(localStorage.getItem(LS_KEY))||[]}catch(e){return[]} }
    function renderList(filter){ if(filter) currentFilter=filter; const el=$('list'); el.textContent=''; const rows=loadAll(); const visible=rows.filter(r=> currentFilter==='all'?true:(r.date===todayStr())); if(!visible.length){ el.textContent='No records'; return; }
      const tOnly=s=>s?s.split('T')[1]?.slice(0,5):'—'; const lines=[]; lines.push('+ADDED(L) | START(kg) | LOC      | TOFF | LAND | TIME  | END(kg)'); lines.push('-----------+-----------+----------+------+------ +-------+--------');
      for(const r of visible){ const hm=r.flightHM||diffHHMM(r.tOff,r.tLand)||'00:00'; const line=[ (r.fuelAdded||'—').toString().padStart(9,' '), (r.fuelStart||'—').toString().padStart(9,' '), (r.loc||'—').toString().padEnd(8,' '), tOnly(r.tOff).padEnd(5,' '), tOnly(r.tLand).padEnd(5,' '), (hm||'00:00').toString().padEnd(5,' '), (r.fuelEnd||'—').toString().padStart(7,' ') ].join(' | '); lines.push(line);} el.textContent=lines.join('\n'); }
    function exportCSV(){ const rows=loadAll(); const visible=rows.filter(r=>currentFilter==='all'?true:(r.date===todayStr())); if(!visible.length){ alert('No records to export.'); return; } const headers=['date','fuelAdded','fuelStart','loc','tOff','tLand','flightTime','fuelEnd']; const csv=[headers.join(',')].concat(visible.map(r=>{ const obj={ date:r.date||'', fuelAdded:r.fuelAdded||'', fuelStart:r.fuelStart||'', loc:r.loc||'', tOff:(r.tOff||'').split('T')[1]?.slice(0,5)||'', tLand:(r.tLand||'').split('T')[1]?.slice(0,5)||'', flightTime:r.flightHM||diffHHMM(r.tOff,r.tLand)||'', fuelEnd:r.fuelEnd||'' }; return headers.map(h=>{ const s=String(obj[h]??''); return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s; }).join(','); })).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`hems-records-${currentFilter==='all'?'all':todayStr()}.csv`; document.body.appendChild(a); a.click(); a.remove(); }

    // ===== GPS (preview-friendly) =====
    function setupGPS(){ const btn=$('gpsBtn'); if(!btn) return; btn.addEventListener('click', ()=>{ const status=$('gpsStatus'); if(!navigator.geolocation){ if(status) status.textContent='GPS not available here (preview sandbox)'; return; } status.textContent='Requesting position… (may be blocked in preview)'; navigator.geolocation.getCurrentPosition( pos=>{ const {latitude:lat, longitude:lon}=pos.coords; $('loc').value = `${lat.toFixed(5)},${lon.toFixed(5)}`; if(status) status.textContent='Location set (lat,lon)'; }, err=>{ if(status) status.textContent='GPS error: '+err.message; }, {enableHighAccuracy:true, timeout:15000, maximumAge:0}); }, {passive:true}); }

    // ===== Wire events & ensure today always correct =====
    function init(){
      patchLandingValueCapture();
      setTodayFields();
      attachInstantCalc();
      populateFuelStart();
      attachFuelLogic();
      setupGPS();
      renderList('today');
      $('exportBtn').addEventListener('click', exportCSV);
      $('saveBtn').addEventListener('click', save);
      $('todayBtn').addEventListener('click', ()=>renderList('today'));
      $('allBtn').addEventListener('click', ()=>renderList('all'));
      $('clearTodayBtn').addEventListener('click', ()=>{
        if(!confirm("Delete ALL of today's records? This cannot be undone.")) return;
        const all = loadAll();
        const remaining = all.filter(r=> r.date !== todayStr());
        localStorage.setItem(LS_KEY, JSON.stringify(remaining));
        if(remaining.length){ const last = remaining[remaining.length-1]; baseStartKg = parseFloat(last.fuelEnd)||0; if(Number.isFinite(baseStartKg)) $('fuelStart').value = baseStartKg.toFixed(1); }
        renderList(currentFilter);
        $('summary').textContent = "Today's records cleared.";
        setTimeout(()=>{$('summary').textContent='';},1500);
      });
      const nowButton = $('nowBtn'); if(nowButton) nowButton.addEventListener('click', setLandingNow, {passive:true});
      document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTodayFields(); }, {passive:true});
      setInterval(()=>{ const d=$('date'); if(d && d.value !== todayStr()) setTodayFields(); }, 60000);
      setTimeout(()=>{ const d=$('date'); if(!d.value) setTodayFields(); if(!$('tLand').value) setTodayFields(); }, 250);

      runSelfTests();
    }

    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();

    // ===== Basic self-tests (no DOM mutation beyond test output) =====
    function runSelfTests(){
      let passed = 0, failed = 0;
      const log = (ok, name)=>{ ok ? passed++ : failed++; console[ok?'log':'error'](`${ok?'✓':'✗'} ${name}`); };

      // Test 1: minutesToHHMM
      log(minutesToHHMM(125) === '02:05', 'minutesToHHMM(125) → 02:05');
      log(minutesToHHMM(0) === '00:00', 'minutesToHHMM(0) → 00:00');
      log(minutesToHHMM(-5) === '00:00', 'minutesToHHMM(-5) floors to 00:00');

      // Test 2: syncDateToLanding mirrors date part (robust, covers edge cases)
      $('tLand').value = '2025-10-19T12:34';
      syncDateToLanding();
      log($('date').value === '2025-10-19', 'syncDateToLanding mirrors landing date');

      // Additional edge-case tests
      $('tLand').value = '2025-10-20'; // date-only input (invalid for datetime-local in some engines)
      syncDateToLanding();
      log($('date').value === '2025-10-20', 'syncDateToLanding handles date-only landing');

      $('tLand').value = 'not-a-date';
      syncDateToLanding();
      log($('date').value !== 'not-a-date', 'syncDateToLanding ignores invalid landing');

      // Test 3: take-off recalculation from flight mins
      $('tLand').value = '2025-10-19T10:30';
      $('flightMins').value = '45';
      $('flightMins').dispatchEvent(new Event('input'));
      log($('tOff').value.endsWith('09:45'), 'Take-off = 45 mins before landing');

      const el = document.getElementById('tests');
      if(el){ el.style.display='block'; el.textContent = `Tests passed: ${passed}, failed: ${failed}`; }
    }
  </script>
</body>
</html>
